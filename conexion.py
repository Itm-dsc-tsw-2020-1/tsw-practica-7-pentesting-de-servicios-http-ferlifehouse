import sqlite3
import requests

#Comandos para crear la base de datos
#En la carpeta del mysql: mysql -u root -h localhost -p
#CREATE DATABASE ports;
#USE ports;
#CREATE TABLE schedule (ip VARCHAR(15), port VARCHAR(15), state VARCHAR(20), service VARCHAR(20), PRIMARY KEY(ip, port, state, service));
#Usamos el script "detectar_puertos.py" para que se ejecute y se llene la BD

def obtener_host():

    cursor = sqlite3.connect('ports.db')
    col = cursor.execute(
        'SELECT ip FROM schedule WHERE service = "http"').fetchall()
    cursor.close()

    return [row[0] for row in col]


def peticiones(hosts, mensajes):

    hosts_aceptados = {}

    for host in hosts:
        try:
            x = requests.get(f'http://{host}/')
        except:
            if mensajes:
                print(f'Hubo un problema al conectar al host: "{host}"')
            continue

        if x.status_code == requests.codes.ok:
            hosts_aceptados[host] = x.text
            if mensajes:
                print(f'Petición exitosa del host: "{host}"')
        else:
            if mensajes:
                print(f'Petición sin éxito del host:"{host}"')

    return hosts_aceptados


def obtener_contenido(mensajes):

    hosts = obtener_host()
    hosts_aceptados = peticiones(hosts, mensajes)
    return hosts_aceptados


if __name__ == '__main__':
    hosts_aceptados = obtener_contenido(True)
